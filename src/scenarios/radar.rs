// Tutorial: Radar (solution)
// Destroy the enemy ships. Use your radar to find them.
// Hint: Press 'g' in-game to show where your radar is looking.
// Hint: Press 'n' to single-step.
// Hint: Use the set_radar_heading() function to keep your radar pointed at a
// target, or to search for a new one.
//
// Join the Discord at https://discord.gg/vYyu9EhkKH for Oort discussion and
// tournament results.
use oort_api::prelude::*;

const BULLET_SPEED: f64 = 1000.0; // m/s

pub struct Ship {}

impl Ship {
    pub fn new() -> Ship {
        Ship {}
    }

    pub fn tick(&mut self) {
        if let Some(contact) = scan() {
            accelerate(0.1 * (contact.position - position() - velocity()));
            turn_to(lead_target(contact.position, contact.velocity));
            fire(0);
            set_radar_heading((contact.position - position()).angle());
        } else {
            set_radar_heading(radar_heading() + radar_width());
        }
    }
}

impl Default for Ship {
    fn default() -> Self {
        Self::new()
    }
}

fn turn_to(target_heading: f64) {
    let heading_error = angle_diff(heading(), target_heading);
    turn(10.0 * heading_error);
}

fn lead_target(target_position: Vec2, target_velocity: Vec2) -> f64 {
    let dp = target_position - position();
    let dv = target_velocity - velocity();
    let predicted_dp = dp + dv * dp.length() / BULLET_SPEED;
    predicted_dp.angle()
}
